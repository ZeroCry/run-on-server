# babel-plugin-run-on-server

[`run-on-server`](https://npm.im/run-on-server) lets you run arbitrary code written on the client (browser, node) on the server (node). It can be great for prototyping, but it's insecure out of the box because its server will eval any JavaScript code you throw at it. That makes it unsuitable for production use because any deployed server would be wide open for attackers to run code on.

This babel plugin solves that issue by making `run-on-server/server` refuse to run any code except for the code that appeared in your source.

Here's how it works:

* The plugin reads through your client source code to find all the places you call `runOnServer`
* It replaces the code you pass into `runOnServer` with an autogenerated ID
* It then outputs an "id mappings file" mapping each ID to the code you passed into `runOnServer`.

This id mappings file can then be fed into `run-on-server/server`, which configures the server so that it _only_ runs code appearing in the id mappings file.

It might be easier to visualize with an example:

Normally, `run-on-server/client` code looks like this:

```js
// src/client.js

import createClient from "run-on-server/client";

const runOnServer = createClient("http://localhost:3001");

runOnServer(() => process.version).then((version) => console.log(version));
```

The babel plugin compiles it to this:

```js
// dist/client.js

import createClient from "run-on-server/client";

const runOnServer = createClient("http://localhost:3001");

runOnServer({
  id: "073f3eb62747a1dbb64a5527c79224ad",
}).then((version) => console.log(version));
```

And the babel plugin also creates an id mappings file with this content:

```js
// run-on-server-id-mappings.js

/*
This file was generated by the run-on-server babel plugin. It should not
be edited by hand.
*/ module.exports = {
  "073f3eb62747a1dbb64a5527c79224ad": () => process.version,
};
```

Note that the autogenerated id (`073f3eb62747a1dbb64a5527c79224ad`) is the same in the code and the id mappings file.

Now, if you feed the id mappings into `run-on-server/server`:

```js
const createServer = require("run-on-server/server");

const server = createServer({
  idMappings: require("./run-on-server-id-mappings"),
});

server.listen(3001, () => {
  console.log("Server is listening on port 3001");
});
```

Then the server will be locked down so that it can only ever run `() => process.version`.

By leveraging this babel plugin, `run-on-server` becomes feasible for use in production-facing libraries and applications.

## Installation

Install the package `babel-plugin-run-on-server`:

```sh
$ npm install --save-dev babel-plugin-run-on-server
# OR
$ yarn add --dev babel-plugin-run-on-server
```

Add it to your `.babelrc`:

```json
{
  "plugins": ["run-on-server"]
}
```

By default, the id mappings file will be written to `run-on-server-id-mappings.js` in whatever directory you run babel in. You can configure it by setting the `outputPath` option in your `.babelrc`:

<!-- prettier-ignore -->
```json
{
  "plugins": [
    ["run-on-server", {
      "outputPath": "./server/idMappings.js"
    }]
  ]
}
```
